name: Update Helm Repository Index

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0

      - name: Install chart-releaser
        uses: helm/chart-releaser-action@v1.7.0
        with:
          install_only: true

      - name: Download chart packages from releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p .cr-release-packages
          # Download all chart packages from GitHub Releases
          for tag in $(gh release list --json tagName -q '.[].tagName' --limit 50); do
            url="https://github.com/purelb/purelb/releases/download/${tag}/purelb-${tag}.tgz"
            if curl -sfI "$url" > /dev/null 2>&1; then
              echo "Downloading purelb-${tag}.tgz"
              curl -sLo ".cr-release-packages/purelb-${tag}.tgz" "$url"
            fi
          done
          ls -la .cr-release-packages/

      - name: Generate Helm repository index
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p website/static/charts

          # cr index generates index.yaml with correct GitHub Release URLs
          # --release-name-template: our releases are tagged v0.14.1, not purelb-v0.14.1
          # --pages-branch main: we commit to main, not gh-pages
          cr index --owner purelb --git-repo purelb \
            --index-path website/static/charts/index.yaml \
            --pages-branch main \
            --release-name-template '{{ .Version }}'

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add website/static/charts/index.yaml
          if ! git diff --staged --quiet; then
            git commit -m "Update Helm repository index for ${{ github.event.release.tag_name }}"
            git push
          fi
